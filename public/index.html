<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedStudios - Dashboard</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MedStudios</h1>
        </div>

        <nav class="nav">
            <ul>
                <li><a href="/" class="active">üè† In√≠cio</a></li>
                <li><a href="/cronograma.html">üìÖ Cronograma</a></li>
                <li><a href="/agenda.html">üìù Agenda</a></li>
                <li><a href="/planejamento.html">üìö Planejamento</a></li>
                <li><a href="/progresso.html">üìä Progresso</a></li>
                <li><a href="/disciplinas.html">üìñ Disciplinas</a></li>
                <li><a href="/professores.html">üë®‚Äçüè´ Professores</a></li>
                <li><a href="/semestre.html">üóìÔ∏è Semestre</a></li>
            </ul>
        </nav>

        <div class="card text-center mb-30">
            <h2>Bem-vindo ao MedStudios</h2>
            <p>Seu painel de controle acad√™mico inteligente</p>
        </div>

        <div class="grid grid--2">
            <!-- Coluna Principal -->
            <div>
                <!-- Agenda Semanal -->
                <div class="card card--success mb-20">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>üìÖ Agenda Semanal</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn--primary" onclick="previousWeek()">‚Äπ</button>
                            <span id="weekRange" style="font-weight: 500; min-width: 200px; text-align: center;">Carregando...</span>
                            <button class="btn btn--primary" onclick="nextWeek()">‚Ä∫</button>
                        </div>
                    </div>
                    
                    <!-- Container da Agenda Semanal -->
                    <div id="weeklyAgenda" class="weekly-agenda">
                        <!-- Dias da semana ser√£o carregados dinamicamente -->
                    </div>
                </div>

                <!-- Cards de Estat√≠sticas -->
                <div class="grid grid--4">
                    <div class="card card--danger text-center">
                        <h2 id="tarefasUrgentes">3</h2>
                        <p>Tarefas Urgentes</p>
                    </div>
                    <div class="card card--warning text-center">
                        <h2 id="proximasEntregas">5</h2>
                        <p>Pr√≥ximas Entregas</p>
                    </div>
                    <div class="card card--success text-center">
                        <h2 id="progressoSemanal">85%</h2>
                        <p>Progresso Semanal</p>
                    </div>
                    <div class="card text-center">
                        <h2 id="mediaGeral">8.7</h2>
                        <p>M√©dia Geral</p>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div>
                <!-- Agenda do Dia -->
                <div class="card card--warning mb-20">
                    <h3>üìã Agenda de Hoje</h3>
                    <div id="todayAgenda">
                        <!-- Agenda de hoje ser√° carregada dinamicamente -->
                    </div>
                </div>

                <!-- Notas Importantes -->
                <div class="card card--purple">
                    <h3>üìù Notas Importantes</h3>
                    <div style="background-color: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--secondary-purple);">
                        <strong>Prova de Bioqu√≠mica:</strong> Revisar metabolismo de carboidratos
                    </div>
                    <div style="background-color: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--secondary-purple);">
                        <strong>Semin√°rio:</strong> Preparar apresenta√ß√£o sobre sistema nervoso
                    </div>
                    <div style="background-color: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--secondary-purple);">
                        <strong>Lembrete:</strong> Renovar matr√≠cula at√© 30/01
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="grid grid--4 mt-30">
            <a href="/agenda.html" class="card card--purple text-center" style="text-decoration: none; color: inherit;">
                <div style="font-size: 2.5rem; margin-bottom: 1rem;">üìù</div>
                <h4>Nova Tarefa</h4>
                <p>Adicionar item √† agenda</p>
            </a>
            <a href="/disciplinas.html" class="card text-center" style="text-decoration: none; color: inherit;">
                <div style="font-size: 2.5rem; margin-bottom: 1rem;">üìñ</div>
                <h4>Gerenciar Disciplinas</h4>
                <p>Organizar mat√©rias do curso</p>
            </a>
            <a href="/cronograma.html" class="card card--warning text-center" style="text-decoration: none; color: inherit;">
                <div style="font-size: 2.5rem; margin-bottom: 1rem;">üìÖ</div>
                <h4>Adicionar Aula</h4>
                <p>Programar hor√°rios</p>
            </a>
            <a href="/professores.html" class="card card--success text-center" style="text-decoration: none; color: inherit;">
                <div style="font-size: 2.5rem; margin-bottom: 1rem;">üë®‚Äçüè´</div>
                <h4>Gerenciar Professores</h4>
                <p>Contatos e informa√ß√µes</p>
            </a>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let currentWeekStart = new Date();
        let weeklyLessons = [];
        
        // Configurar in√≠cio da semana (segunda-feira)
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajustar para segunda-feira
            return new Date(d.setDate(diff));
        }
        
        // Formatar data para exibi√ß√£o
        function formatDate(date) {
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit'
            });
        }
        
        // Formatar data para API (YYYY-MM-DD)
        function formatDateForAPI(date) {
            return date.toISOString().split('T')[0];
        }
        
        // Obter nome do dia da semana
        function getDayName(date) {
            const days = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            return days[date.getDay()];
        }
        
        // Carregar aulas da semana da API
        async function loadWeeklyLessons() {
            try {
                const weekStart = formatDateForAPI(currentWeekStart);
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                const weekEndFormatted = formatDateForAPI(weekEnd);
                
                // Fazer requisi√ß√£o para a API com filtro de data
                const response = await fetch(`/api/lessons?startDate=${weekStart}&endDate=${weekEndFormatted}`);
                
                if (response.ok) {
                    weeklyLessons = await response.json();
                } else {
                    console.error('Erro ao carregar aulas:', response.statusText);
                    // Fallback para dados de exemplo
                    weeklyLessons = [
                        {
                            _id: '1',
                            title: 'Anatomia Humana',
                            description: 'Sistema Cardiovascular',
                            date: formatDateForAPI(new Date()),
                            time: '08:00',
                            subject: { name: 'Anatomia', color: '#3357FF' },
                            professor: { name: 'Dr. Silva' }
                        },
                        {
                            _id: '2',
                            title: 'Fisiologia',
                            description: 'Sistema Respirat√≥rio',
                            date: formatDateForAPI(new Date()),
                            time: '14:00',
                            subject: { name: 'Fisiologia', color: '#33FF57' },
                            professor: { name: 'Dra. Costa' }
                        }
                    ];
                }
                
                renderWeeklyAgenda();
                renderTodayAgenda();
                
            } catch (error) {
                console.error('Erro na conex√£o com a API:', error);
                weeklyLessons = [];
                renderWeeklyAgenda();
                renderTodayAgenda();
            }
        }
        
        // Renderizar agenda semanal
        function renderWeeklyAgenda() {
            const container = document.getElementById('weeklyAgenda');
            container.innerHTML = '';
            
            // Atualizar range da semana
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            document.getElementById('weekRange').textContent = 
                `${formatDate(currentWeekStart)} - ${formatDate(weekEnd)}`;
            
            // Criar containers para cada dia da semana
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(currentWeekStart);
                dayDate.setDate(dayDate.getDate() + i);
                
                const dayContainer = document.createElement('div');
                dayContainer.className = 'day-container';
                dayContainer.style.cssText = `
                    margin-bottom: 15px;
                    padding: 15px;
                    border-radius: 8px;
                    background-color: #f8fafc;
                    border-left: 4px solid var(--primary-blue);
                `;
                
                // Cabe√ßalho do dia
                const dayHeader = document.createElement('div');
                dayHeader.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 10px;
                    font-weight: 600;
                    color: var(--text-color);
                `;
                
                const dayName = getDayName(dayDate);
                const isToday = dayDate.toDateString() === new Date().toDateString();
                
                dayHeader.innerHTML = `
                    <span style="${isToday ? 'color: var(--success-green);' : ''}">
                        ${dayName}
                    </span>
                    <span style="font-size: 0.9rem; color: var(--text-gray);">
                        ${formatDate(dayDate)}
                    </span>
                `;
                
                dayContainer.appendChild(dayHeader);
                
                // Filtrar aulas do dia
                const dayLessons = weeklyLessons.filter(lesson => {
                    const lessonDate = new Date(lesson.date);
                    return lessonDate.toDateString() === dayDate.toDateString();
                });
                
                // Renderizar aulas do dia
                if (dayLessons.length === 0) {
                    const noLessons = document.createElement('div');
                    noLessons.style.cssText = `
                        color: var(--text-gray);
                        font-style: italic;
                        font-size: 0.9rem;
                        text-align: center;
                        padding: 10px;
                    `;
                    noLessons.textContent = 'Nenhuma aula agendada';
                    dayContainer.appendChild(noLessons);
                } else {
                    dayLessons.forEach(lesson => {
                        const lessonElement = document.createElement('div');
                        lessonElement.style.cssText = `
                            background-color: white;
                            padding: 12px;
                            border-radius: 6px;
                            margin-bottom: 8px;
                            border-left: 3px solid ${lesson.subject?.color || 'var(--primary-blue)'};
                            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                        `;
                        
                        lessonElement.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
                                <div style="font-weight: 500; color: var(--text-color);">
                                    ${lesson.title || lesson.subject?.name || 'Aula'}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-gray); font-weight: 600;">
                                    ${lesson.time || '00:00'}
                                </div>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-gray); margin-bottom: 3px;">
                                ${lesson.description || 'Sem descri√ß√£o'}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-gray);">
                                Prof. ${lesson.professor?.name || 'N√£o informado'}
                            </div>
                        `;
                        
                        dayContainer.appendChild(lessonElement);
                    });
                }
                
                container.appendChild(dayContainer);
            }
        }
        
        // Renderizar agenda de hoje
        function renderTodayAgenda() {
            const container = document.getElementById('todayAgenda');
            const today = new Date();
            
            const todayLessons = weeklyLessons.filter(lesson => {
                const lessonDate = new Date(lesson.date);
                return lessonDate.toDateString() === today.toDateString();
            });
            
            if (todayLessons.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-gray); font-style: italic; padding: 20px;">
                        Nenhuma aula agendada para hoje
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            todayLessons.forEach(lesson => {
                const lessonElement = document.createElement('div');
                lessonElement.style.cssText = `
                    background-color: #fef3c7;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 10px;
                    display: flex;
                    gap: 15px;
                `;
                
                lessonElement.innerHTML = `
                    <div style="font-weight: 600; color: #92400e; min-width: 60px;">
                        ${lesson.time || '00:00'}
                    </div>
                    <div>
                        <div style="font-weight: 500; color: #92400e;">
                            ${lesson.title || lesson.subject?.name || 'Aula'}
                        </div>
                        <div style="font-size: 0.9rem; color: #a16207;">
                            ${lesson.description || 'Sem descri√ß√£o'}
                        </div>
                    </div>
                `;
                
                container.appendChild(lessonElement);
            });
        }
        
        // Navegar para semana anterior
        function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            loadWeeklyLessons();
        }
        
        // Navegar para pr√≥xima semana
        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            loadWeeklyLessons();
        }
        
        // Carregar estat√≠sticas do dashboard
        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/dashboard/stats');
                if (response.ok) {
                    const stats = await response.json();
                    
                    // Atualizar elementos do dashboard
                    if (document.getElementById('totalSubjects')) {
                        document.getElementById('totalSubjects').textContent = stats.totalSubjects;
                    }
                    if (document.getElementById('completedTasks')) {
                        document.getElementById('completedTasks').textContent = stats.completedTasks;
                    }
                    if (document.getElementById('pendingTasks')) {
                        document.getElementById('pendingTasks').textContent = stats.pendingTasks;
                    }
                    if (document.getElementById('averageGrade')) {
                        document.getElementById('averageGrade').textContent = stats.averageGrade;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }
        
        // Inicializar dashboard
        function initDashboard() {
            // Configurar semana atual
            currentWeekStart = getWeekStart(new Date());
            
            // Carregar dados
            loadWeeklyLessons();
            loadDashboardStats();
        }
        
        // Carregar dados quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>