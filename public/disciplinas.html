<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedStudios - Disciplinas</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MedStudios</h1>
        </div>

        <nav class="nav">
            <ul>
                <li><a href="/">üè† In√≠cio</a></li>
                <li><a href="/cronograma.html">üìÖ Cronograma</a></li>
                <li><a href="/agenda.html">üìù Agenda</a></li>
                <li><a href="/planejamento.html">üìö Planejamento</a></li>
                <li><a href="/progresso.html">üìä Progresso</a></li>
                <li><a href="/disciplinas.html" class="active">üìñ Disciplinas</a></li>
                <li><a href="/professores.html">üë®‚Äçüè´ Professores</a></li>
                <li><a href="/semestre.html">üóìÔ∏è Semestre</a></li>
            </ul>
        </nav>

        <div class="card text-center mb-30">
            <h2>üìñ Disciplinas</h2>
            <p>Gerencie suas disciplinas e acompanhe seu progresso acad√™mico</p>
        </div>

        <!-- Bot√£o Adicionar -->
        <div class="mb-20">
            <button class="btn btn--primary" onclick="showAddForm()">+ Adicionar Nova Disciplina</button>
        </div>

        <!-- Formul√°rio de Adicionar/Editar -->
        <div id="disciplineForm" class="card mb-30" style="display: none;">
            <h3 id="formTitle">Adicionar Nova Disciplina</h3>
            <form id="disciplineFormElement">
                <input type="hidden" id="disciplineId">
                <div class="grid grid--2">
                    <div class="form-group">
                        <label for="disciplineName">Nome da Disciplina</label>
                        <input type="text" id="disciplineName" required>
                    </div>
                    <div class="form-group">
                        <label for="disciplineCode">C√≥digo</label>
                        <input type="text" id="disciplineCode" required>
                    </div>
                    <div class="form-group">
                        <label for="disciplineCredits">Cr√©ditos</label>
                        <input type="number" id="disciplineCredits" min="1" max="10" required>
                    </div>
                    <div class="form-group">
                        <label for="disciplineProfessor">Professor</label>
                        <input type="text" id="disciplineProfessor" required>
                    </div>
                    <div class="form-group">
                        <label for="disciplineSchedule">Hor√°rio</label>
                        <input type="text" id="disciplineSchedule" placeholder="Ex: Seg/Qua 08:00-10:00" required>
                    </div>
                    <div class="form-group">
                        <label for="disciplineGrade">Nota Atual</label>
                        <input type="number" id="disciplineGrade" min="0" max="10" step="0.1">
                    </div>
                </div>
                <div class="form-group">
                    <label for="disciplineProgress">Progresso (%)</label>
                    <input type="range" id="disciplineProgress" min="0" max="100" value="0" oninput="updateProgressValue(this.value)">
                    <span id="progressValue">0%</span>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn--primary">Salvar</button>
                    <button type="button" class="btn btn--secondary" onclick="hideForm()">Cancelar</button>
                </div>
            </form>
        </div>

        <!-- Lista de Disciplinas -->
        <div class="grid grid--2" id="disciplinesGrid">
            <!-- Disciplinas ser√£o carregadas dinamicamente -->
        </div>
    </div>

    <script>
        // Dados das disciplinas vir√£o do backend via API
        let disciplinesData = [];
        let nextId = 1;

        // Fun√ß√£o para carregar disciplinas da API
        async function loadDisciplinesFromAPI() {
            try {
                const response = await fetch('/api/subjects');
                if (response.ok) {
                    disciplinesData = await response.json();
                    loadDisciplines();
                } else {
                    console.error('Erro ao carregar disciplinas:', response.statusText);
                    // Fallback para dados de exemplo se a API falhar
                    disciplinesData = [
                        {
                            _id: '1',
                            name: "Anatomia Humana",
                            code: "MED101",
                            credits: 6,
                            professor: "Dr. Silva",
                            schedule: "Seg/Qua 08:00-10:00",
                            workload: 80,
                            color: "#3357FF"
                        }
                    ];
                    loadDisciplines();
                }
            } catch (error) {
                console.error('Erro na conex√£o com a API:', error);
                disciplinesData = [];
                loadDisciplines();
            }
        }

        function loadDisciplines() {
            const grid = document.getElementById('disciplinesGrid');
            grid.innerHTML = '';
            
            if (disciplinesData.length === 0) {
                grid.innerHTML = '<div class="card text-center"><p>Nenhuma disciplina encontrada. Adicione uma nova disciplina!</p></div>';
                return;
            }
            
            disciplinesData.forEach(discipline => {
                const card = document.createElement('div');
                card.className = 'card';
                
                // Usar dados do MongoDB (ajustar campos)
                const credits = discipline.credits || discipline.workload || 0;
                const progress = discipline.progress || Math.floor(Math.random() * 100); // Tempor√°rio
                const grade = discipline.grade || (Math.random() * 4 + 6).toFixed(1); // Tempor√°rio
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div>
                            <h3 style="margin-bottom: 5px;">${discipline.name}</h3>
                            <p style="color: var(--text-gray); font-size: 0.9rem;">${discipline.code}</p>
                        </div>
                        <span style="background-color: ${discipline.color || 'var(--primary-blue)'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem;">
                            ${credits} ${discipline.workload ? 'h' : 'cr√©ditos'}
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: var(--text-gray);">Professor:</span>
                            <span style="font-weight: 500;">${discipline.professor || 'N√£o informado'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: var(--text-gray);">Descri√ß√£o:</span>
                            <span style="font-weight: 500; font-size: 0.9rem;">${discipline.description || 'Sem descri√ß√£o'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--text-gray);">Nota Atual:</span>
                            <span style="font-weight: 500; color: ${grade >= 7 ? 'var(--success-green)' : grade >= 5 ? 'var(--warning-orange)' : 'var(--danger-red)'};">                                ${grade}
                            </span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: var(--text-gray); font-size: 0.9rem;">Progresso</span>
                            <span style="font-size: 0.9rem; font-weight: 500;">${progress}%</span>
                        </div>
                        <div style="width: 100%; height: 8px; background-color: #e5e7eb; border-radius: 10px; overflow: hidden;">
                            <div style="height: 100%; background-color: var(--success-green); width: ${progress}%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn--primary" onclick="editDiscipline('${discipline._id}')" style="flex: 1;">Editar</button>
                        <button class="btn btn--danger" onclick="deleteDiscipline('${discipline._id}')" style="flex: 1;">Excluir</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function showAddForm() {
            document.getElementById('formTitle').textContent = 'Adicionar Nova Disciplina';
            document.getElementById('disciplineFormElement').reset();
            document.getElementById('disciplineId').value = '';
            document.getElementById('disciplineForm').style.display = 'block';
            updateProgressValue(0);
        }

        function editDiscipline(id) {
            const discipline = disciplinesData.find(d => d.id === id);
            if (discipline) {
                document.getElementById('formTitle').textContent = 'Editar Disciplina';
                document.getElementById('disciplineId').value = discipline.id;
                document.getElementById('disciplineName').value = discipline.name;
                document.getElementById('disciplineCode').value = discipline.code;
                document.getElementById('disciplineCredits').value = discipline.credits;
                document.getElementById('disciplineProfessor').value = discipline.professor;
                document.getElementById('disciplineSchedule').value = discipline.schedule;
                document.getElementById('disciplineGrade').value = discipline.grade;
                document.getElementById('disciplineProgress').value = discipline.progress;
                updateProgressValue(discipline.progress);
                document.getElementById('disciplineForm').style.display = 'block';
            }
        }

        async function deleteDiscipline(id) {
            if (confirm('Tem certeza que deseja excluir esta disciplina?')) {
                try {
                    const response = await fetch(`/api/subjects/${id}`, { 
                        method: 'DELETE' 
                    });
                    
                    if (response.ok) {
                        await loadDisciplinesFromAPI(); // Recarregar da API
                    } else {
                        alert('Erro ao excluir disciplina');
                    }
                } catch (error) {
                    console.error('Erro ao excluir:', error);
                    alert('Erro na conex√£o com o servidor');
                }
            }
        }

        function hideForm() {
            document.getElementById('disciplineForm').style.display = 'none';
        }

        function updateProgressValue(value) {
            document.getElementById('progressValue').textContent = value + '%';
        }

        // Manipular envio do formul√°rio
        document.getElementById('disciplineFormElement').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('disciplineId').value;
            const disciplineData = {
                name: document.getElementById('disciplineName').value,
                code: document.getElementById('disciplineCode').value,
                credits: parseInt(document.getElementById('disciplineCredits').value),
                professor: document.getElementById('disciplineProfessor').value,
                description: `Disciplina ${document.getElementById('disciplineName').value}`,
                workload: parseInt(document.getElementById('disciplineCredits').value) * 15, // Estimativa
                color: '#3357FF' // Cor padr√£o
            };
            
            try {
                let response;
                if (id) {
                    // Editar disciplina existente
                    response = await fetch(`/api/subjects/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(disciplineData)
                    });
                } else {
                    // Adicionar nova disciplina
                    response = await fetch('/api/subjects', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(disciplineData)
                    });
                }
                
                if (response.ok) {
                    hideForm();
                    await loadDisciplinesFromAPI(); // Recarregar da API
                } else {
                    const error = await response.text();
                    alert('Erro ao salvar disciplina: ' + error);
                }
            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('Erro na conex√£o com o servidor');
            }
        });

        // Carregar disciplinas quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', loadDisciplinesFromAPI);
    </script>
</body>
</html>